#!/usr/bin/env bash

set -eo pipefail

if [[ "$#" -lt 1 ]]; then
  echo "usage: git deploy <user>@<server>"
  echo "   ex: git deploy bob@prod.server.com"
  echo ""
  exit 1
fi

server=$1
repo_name=$(basename $(git rev-parse --show-toplevel))
git_root=".git_deploy"
hook=~/${git_root}/$repo_name.git/hooks/pre-receive

function init_remote() {
  # Create remote repository
  ssh $server <<DOC
if [[ ! -d ~/${git_root}/$repo_name ]]; then
  mkdir -p ~/${git_root}/$repo_name.git
  cd ~/${git_root}/$repo_name.git/
  git init --bare
  git --bare update-server-info
  touch $hook
  chmod +x $hook
fi
DOC

  # Add/update pre-receive hook
  ssh $server "cat > $hook" <<DOC
#!/bin/sh
while read old new refname; do
  build_dir=.build/\$new
  mkdir -p \$build_dir
  git archive \$new | tar -x -C \$build_dir
  cd \$build_dir
  make git-deploy || exit 1
  pwd
done
DOC

  git remote add $server $server:${git_root}/$repo_name.git
}

if ! git remote get-url $server &> /dev/null; then
  echo "Checking remote repository"
  init_remote
fi
echo "Pushing to $server"
git push $server master
